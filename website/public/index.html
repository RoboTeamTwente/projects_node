<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>RobotCommand GUI</title>

		<link rel="stylesheet" href="libs/bootstrap.min.css">
		<link rel="stylesheet" href="style.css">


		<script src="libs/socket.io.slim.js"></script>
		<script src="libs/vue"></script>
		<script src="libs/lodash.min.js"></script>

	</head>
	<body>
		
		<div id="app" class="container">

			{{ Hz.toFixed(1) }} - {{ disabled }}

			<div class="row">
				<div v-for="(wave, key) in waves" class="wer col-md-4">
					<wave-control :target="TARGETS[key]" :id="key" v-on:wave-changed="updateWave"  class="wave" inline-template
						:class="COLOURS[key]"
					>
						<div>
							<div>
								<h2><b>{{ target }}</b> : {{ val.toFixed(4) }}</h2>
							</div>

							<!-- FREQUENCY, AMPLITUDE, OFFSET -->
							<div>

								<div class="input-group input-group-sm mb-12">
									<div class="input-group-prepend">
										<span class="input-group-text" id="inputGroup-sizing-sm">Frequency</span>
									</div>
									<input v-model="wave.frequency" @change="settingsChanged" type="text" class="form-control" :disabled="disabled">
								</div>
								<div class="input-group input-group-sm mb-12">
									<div class="input-group-prepend">
										<span class="input-group-text" id="inputGroup-sizing-sm">Amplitude</span>
									</div>
									<input v-model="wave.amplitude" @change="settingsChanged" type="text" class="form-control" :disabled="disabled">
								</div>

								<div class="input-group input-group-sm mb-12">
									<div class="input-group-prepend">
										<span class="input-group-text" id="inputGroup-sizing-sm">Offset</span>
									</div>
									<input v-model="wave.offset" @change="settingsChanged" type="text" class="form-control" :disabled="disabled">
								</div>

							</div>
							<!-- ========================= -->

							<!-- WAVE SELECTOR -->
							<div class="input-group mb-3">
								<div class="input-group-prepend">
									<label class="input-group-text" for="waveSelector">Wave</label>
								</div>
								<select v-model="wave.wave" class="custom-select" id="waveSelector" @change="waveChanged" :disabled="disabled">
									<option value="Constant"> Constant </option>
									<option value="SineWave"> Sine </option>
									<option value="CosineWave"> Cosine  </option>
									<option value="BlockWave"> Block </option>
									<option value="SawWave"> Saw </option>
									<option value="SineWaveInverted"> Sine Inverted </option>
									<option value="CosineWaveInverted"> Cosine Inverted </option>
									<option value="BlockWaveInverted"> Block Inverted </option>
									<option value="SawWaveInverted"> Saw Inverted </option>
								</select>
							</div>
							<!-- ============= -->

						</div>
					</wave-control>
				</div> <!-- // For each wave -->
			</div>

			<div class="row" style="margin-top : 10px;">
				<div class="col-md-4">
					<div class="input-group input-group-sm mb-12">
						<div class="input-group-prepend">
							<span class="input-group-text" id="inputGroup-sizing-sm">Robot ID</span>
						</div>
						<input v-model="settings.robot_id" @change="settingsChanged" type="text" class="form-control" :disabled="disabled">
					</div>
				</div>

				<div class="col-md-6">
					<button v-on:click="toggleRunning" type="button" :class="btn.class" class="btn btn-sm btn-block" :disabled="!connected || !settings.ros_running">{{ btn.text }}</button>
				</div>

				<div class="col-md-2">
					<button v-on:click="kick" type="button" class="btn btn-sm btn-block btn-danger" :disabled="!connected || !settings.ros_running || !settings.running"> Kick! </button>
				</div>
			</div>

			<br>

			<!-- === CANVAS === -->
			<div class="row" >
				<div class="col-md-6">
					<canvas id="myCanvas" width=555 height=500 class="canvas"></canvas>
				</div>
				<div class="col-md-6">
					<canvas id="canvasCoordinates" width=555 height=500 class="canvas"></canvas>
				</div>
			</div>
			<!-- === CANVAS === -->

		</div>

		<script src="Artist.js"></script>
		<script src="Wave.js"></script>
		<script src="waveControl.js"></script>

		<script>
			
			const WIDTH = 3;
			const HEIGHT= 1;
			const TARGETS = ['x_vel', 'y_vel', 'w'];
            const COLOURS = ['red', 'green', 'blue'];
			const RESOLUTION = 200;

			let waves = [];
			let series = [];
			for(let y = 0; y < HEIGHT; y++){
				for(let x = 0; x < WIDTH; x++){
					let id = y * WIDTH + x;
					waves[id] = new Wave(id);

					series[id] = [];
					for(let i = 0; i < RESOLUTION; i++){
					    series[id].push(0);
					}

				}
			}

			let app = new Vue({
				el: '#app',
				data: { 

					lastReceived : Date.now(),
					connected : false,
					Hz : 0,

					settings : {
						robot_id : 0,
						running : false,
						ros_running : false,
						waveManager : {
							running : false,
						}
					},

                    btn : {
					    text : "",
						class : ""
                    },
				},

				computed : {
					disabled : function(){ return this.settings.waveManager.running || !this.connected || !this.settings.ros }
				},

				methods : {
				    updateHz : function(){
						let now = Date.now();
						this.Hz = 1000 / (now - this.lastReceived);
						this.lastReceived = now;
					},

					toggleRunning : function(){
						console.log("Toggling running!")
						this.settings.waveManager.running = !this.settings.waveManager.running
						this.settingsChanged()
					},

					settingsChanged : function(){
						console.log("Settings changed!")
						socket.emit("settings", this.settings)
						console.log("Settings emitted")
					},

                    updateStatus : function(status){
				        this.settings.waveManager.running = status.settings.waveManager.running;
				        this.updateButton();
					},

					setConnection : function(isConnected){
				        this.connected = isConnected;
						this.updateButton();
					},

					updateButton : function(){
                        if(this.connected) {
                            if(!this.settings.ros_running){
                                this.btn.class = "btn-secondary";
                                this.btn.text = "Waiting for ros to run..";
							}else
                            if(this.settings.waveManager.running) {
                                this.btn.class = "btn-danger";
                                this.btn.text = "Stop";
                            }else{
                                this.btn.class = "btn-success";
                                this.btn.text = "Start";
                            }
                        }else{
                           this.btn.class = "btn-secondary";
                           this.btn.text = "Waiting for connection..";
                        }
					},

                    updateWave : function(settings){
						socket.emit('settings', settings);
					},

					kick : function(){
                        console.log("Kick received!")
						socket.emit('kick');
					}
				},

				mounted : function(){
					console.log("App mounted")
				}
			});

			console.log(window.location.hostname);

            let socket = io(window.location.hostname + ':3001');

			socket.on('connect', () => {
				app.setConnection(true);
			});
			socket.on('disconnect', () => {
			    app.setConnection(false);
			});

            socket.on('tick', data => {
                app.setConnection(true);
                app.updateHz();

                artist.clear();
                artist.drawGrid();

                _.each(data, (val, id) => {

                    if(waves[id]) {
                        waves[id].setVal(val);
                        series[id].shift();
                        series[id].push(val);
                    }

					artist.drawSeries(series[id], COLOURS[id])

                });

            });

            socket.on('status', status => {
                console.log("Status received:", status);
                app.updateStatus(status);
			})

            socket.on('settings', settings => {
				console.log(settings);

				_.each(settings, (val, setting) => {
					console.log(setting, val)

					if(setting == "waves"){
						let wave = waves[setting.id];
						if(wave) {
							_.each(setting, (val, key) => {
								wave[key] = val
							})
						}
					}else{
						app.settings[setting] = val
					}
				})
				let f = (s,x) => _.map(x,(v,k)=> typeof v == "object" ? f(`${s}.${k}`,v) : `${s}.${k}=${v}`).join("\n")
				console.log(f("app.settings", app.settings))
				app.updateButton()
            });

            const artist = new Artist()

		</script>

	</body>
</html>





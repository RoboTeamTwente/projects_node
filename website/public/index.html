<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>RobotCommand GUI</title>

		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
		<link rel="stylesheet" href="style.css">


		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.0/socket.io.slim.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/vue"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.5/lodash.min.js"></script>

	</head>
	<body>
		
		<div id="app" class="container">

			{{ Hz.toFixed(1) }}

			<div class="row">
				<div v-for="(wave, key) in waves" class="wer col-md-4">
					<wave-control :target="TARGETS[key]" :id="key" v-on:wave-changed="updateWave"  class="wave" inline-template
						:class="{red : key==0, green : key==1, blue : key==2}"
					>
						<div>
							<div>
								<h2><b>{{ target }}</b> : {{ val.toFixed(4) }}</h2>
							</div>

							<!-- FREQUENCY, AMPLITUDE, OFFSET -->
							<div>

								<div class="input-group input-group-sm mb-12">
									<div class="input-group-prepend">
										<span class="input-group-text" id="inputGroup-sizing-sm">Frequency</span>
									</div>
									<input v-model="wave.frequency" @change="waveChanged" type="text" class="form-control" :disabled="running || !connected">
								</div>
								<div class="input-group input-group-sm mb-12">
									<div class="input-group-prepend">
										<span class="input-group-text" id="inputGroup-sizing-sm">Amplitude</span>
									</div>
									<input v-model="wave.amplitude" @change="waveChanged" type="text" class="form-control" :disabled="running || !connected">
								</div>

								<div class="input-group input-group-sm mb-12">
									<div class="input-group-prepend">
										<span class="input-group-text" id="inputGroup-sizing-sm">Offset</span>
									</div>
									<input v-model="wave.offset" @change="waveChanged" type="text" class="form-control" :disabled="running || !connected">
								</div>

							</div>
							<!-- ========================= -->

							<!-- WAVE SELECTOR -->
							<div class="input-group mb-3">
								<div class="input-group-prepend">
									<label class="input-group-text" for="waveSelector">Wave</label>
								</div>
								<select v-model="wave.wave" class="custom-select" id="waveSelector" @change="waveChanged" :disabled="running || !connected">
									<option value="Constant"> Constant </option>
									<option value="SineWave"> SineWave </option>
									<option value="CosineWave"> CosineWave </option>
									<option value="BlockWave"> BlockWave </option>
									<option value="SawWave"> SawWave </option>
									<option value="SineWaveInverted"> SineWaveInverted </option>
									<option value="CosineWaveInverted"> CosineWaveInverted </option>
									<option value="BlockWaveInverted"> BlockWaveInverted </option>
									<option value="SawWaveInverted"> SawWaveInverted </option>
								</select>
							</div>
							<!-- ============= -->

						</div>
					</wave-control>
				</div> <!-- // For each wave -->
			</div>

			<div class="row" style="margin-top : 10px;">
				<div class="col-md-4">
					<div class="input-group input-group-sm mb-12">
						<div class="input-group-prepend">
							<span class="input-group-text" id="inputGroup-sizing-sm">Robot ID</span>
						</div>
						<input v-model="robot_id" @change="robotChanged" type="text" class="form-control" :disabled="running || !connected">
					</div>
				</div>

				<div class="col-md-8">
					<button v-on:click="update" type="button" :class="btn.class" class="btn btn-sm btn-block">{{ btn.text }}</button>
				</div>
			</div>

			<div class="row" style="margin-top : 10px;">
				<div class="col-md-12">
					<canvas id="myCanvas" width=1110 height=500 class="canvas"></canvas>
				</div>

			</div>

		</div>

		<script src="Artist.js"></script>
		<script src="Wave.js"></script>
		<script src="waveControl.js"></script>

		<script>
			
			const WIDTH = 3;
			const HEIGHT= 1;
			const TARGETS = ['x_vel', 'y_vel', 'w'];
			const RESOLUTION = 200;

			let waves = [];
			let series = [];
			for(let y = 0; y < HEIGHT; y++){
				for(let x = 0; x < WIDTH; x++){
					let id = y * WIDTH + x;
					waves[id] = new Wave(id);

					series[id] = [];
					for(let i = 0; i < RESOLUTION; i++){
					    series[id].push(0);
					}

				}
			}

			let app = new Vue({
				el: '#app',
				data: { 

                    btn : {
					    text : "",
						class : ""
                    },

					lastReceived : Date.now(),
					connected : false,
					running : false,
					Hz : 0,

					robot_id : 0
				},

				methods : {
				    updateHz : function(){
						let now = Date.now();
						this.Hz = 1000 / (now - this.lastReceived);
						this.lastReceived = now;
					},

                    updateStatus : function(status){
				        this.running = status.running;
				        this.updateButton();
					},

					setConnection : function(isConnected){
				        this.connected = isConnected;
						this.updateButton();
					},

					updateButton : function(){
                        if(this.connected) {
                            if(this.running) {
                                this.btn.class = "btn-danger";
                                this.btn.text = "Stop";
                            }else{
                                this.btn.class = "btn-success";
                                this.btn.text = "Start";
                            }
                        }else{
                            this.btn.class = "btn-secondary";
                            this.btn.text = "Waiting for connection..";
                        }
					},

                    updateWave : function(settings){
						socket.emit('settings', settings);
					},

					robotChanged : function(){
						console.log("Robot ID changed to " + this.robot_id)
                        socket.emit('robot_id', this.robot_id);
					},

                    update : function(){
						socket.emit('control', {
							running : !this.running
						})
					}
				},

				mounted : function(){
					console.log("App mounted")
				}
			});


            let socket = io('http://localhost:3001');

			socket.on('connect', () => {
				app.setConnection(true);
			});
			socket.on('disconnect', () => {
			    app.setConnection(false);
			});

            socket.on('tick', data => {
                app.setConnection(true);
                app.updateHz();

                artist.clear();
                artist.drawGrid();

                let colours = ["red", "green", "blue"];

                _.each(data, (val, id) => {

                    if(waves[id]) {
                        waves[id].setVal(val);
                        series[id].shift();
                        series[id].push(val);
                    }

					artist.drawSeries(series[id], colours[id])

                });

            });

            socket.on('status', status => {
                console.log("Status received:", status);
                app.updateStatus(status);
			})

            socket.on('settings', settings => {
                console.log(settings);
                _.each(settings, setting => {
                    let wave = waves[setting.id];
                    if(wave) {
                        _.each(setting, (val, key) => {
                            wave[key] = val
                        });
                    }
                })
            });

            socket.on('robot_id', robot_id => {
                console.log("Robot ID changed", robot_id);
				app.robot_id = robot_id;
			});

            const artist = new Artist()

		</script>

	</body>
</html>




